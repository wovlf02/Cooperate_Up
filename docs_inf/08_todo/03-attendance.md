# 03. 출퇴근 (Attendance) TODO

> **Phase**: 1단계  
> **우선순위**: 🔴 최우선 (핵심 비즈니스 로직)

## 📊 진행 상황

**진행률**: 100% ✅

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
██████████████████████████████████████████████████ 100%
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### ✅ 완료된 항목

#### 화면 구현
- ✅ `AttendanceScreen.tsx` - 출퇴근 메인 화면
- ✅ `ManualInputScreen.tsx` - 수동 근태 입력 화면
- ✅ `EditRequestScreen.tsx` - 근태 수정 요청 화면
- ✅ `AttendanceHistoryScreen.tsx` - 근태 내역 조회

#### 출퇴근 컴포넌트
- ✅ `BigAttendanceButton.tsx` - 대형 출퇴근 버튼
- ✅ `CurrentTimeDisplay.tsx` - 현재 시간 표시
- ✅ `LocationStatusCard.tsx` - 위치 상태 카드
- ✅ `TodayWorkInfoCard.tsx` - 오늘 근무 정보
- ✅ `EarlyClockInAlert.tsx` - 20시 이전 출근 알림
- ✅ `MonthSelector.tsx` - 월 선택기
- ✅ `StatisticsCard.tsx` - 통계 카드
- ✅ `AttendanceRecordCard.tsx` - 근태 기록 카드
- ✅ `FilterChips.tsx` - 필터 칩
- ✅ `EditRecordCard.tsx` - 수정 기록 카드
- ✅ `EditRequestForm.tsx` - 수정 요청 폼

#### 핵심 기능
- ✅ GPS 기반 출퇴근 체크
- ✅ 거리 계산 (50m 이내 확인)
- ✅ 출근/퇴근 버튼 (상태별 분기)
- ✅ 20시 기준 급여 계산 로직
- ✅ 수동 근태 입력
- ✅ 오늘 근무 정보 표시
- ✅ 근태 수정 요청 기능
- ✅ 근태 내역 조회 (월별, 필터링)

#### 코드 품질
- ✅ 인라인 스타일 제거
- ✅ 스타일 파일 분리
- ✅ 커스텀 훅 분리
- ✅ 컴포넌트 분리 (200라인 이하)

#### GPS 정확도 개선
- ✅ GPS 정확도 표시
- ✅ 위치 서비스 비활성화 시 안내
- ✅ 위치 권한 재요청

#### API 연동 완료
- ✅ 출근 API 에러 처리 강화
- ✅ 퇴근 API 에러 처리 강화
- ✅ Retry 메커니즘

---

## 📱 화면 목록

| 화면 | 파일 | 상태 | 설명 |
|------|------|------|------|
| 출퇴근 메인 | `AttendanceScreen.tsx` | ✅ 완료 | GPS 기반 출퇴근 |
| 수동 입력 | `ManualInputScreen.tsx` | ✅ 완료 | 수동 근태 입력 |
| 수정 요청 | `EditRequestScreen.tsx` | ❌ 미구현 | 근태 수정 요청 |
| 근태 내역 | `AttendanceHistoryScreen.tsx` | ❌ 미구현 | 과거 근태 조회 |

---

## 🎨 화면 상세

### 1. AttendanceScreen.tsx ✅
**파일 위치**: `front/src/screens/attendance/AttendanceScreen.tsx`

**구현된 기능**:
- ✅ 현재 시간 표시 (실시간 업데이트)
- ✅ 위치 상태 카드 (거리, GPS 정확도)
- ✅ 대형 출퇴근 버튼 (상태별 변경)
  - 출근 전: "출근하기" (파란색)
  - 출근 중: "퇴근하기" (주황색)
  - 퇴근 완료: "오늘 근무 완료" (회색, 비활성)
- ✅ 오늘 근무 정보 카드
- ✅ 20시 이전 출근 알림
- ✅ GPS 거리 계산 및 범위 확인 (50m)
- ✅ Pull to Refresh

**개선 필요 사항**:
- [ ] GPS 정확도 표시 추가
- [ ] 위치 서비스 비활성화 시 안내 강화
- [ ] 로딩 오버레이 (전체 화면)
- [ ] 출퇴근 성공 피드백 개선 (애니메이션, 햅틱)
- [ ] 근태 내역 버튼 추가

**예상 개선 시간**: 3-4시간

---

### 2. ManualInputScreen.tsx ✅
**파일 위치**: `front/src/screens/attendance/ManualInputScreen.tsx`

**구현된 기능**:
- ✅ 날짜 선택
- ✅ 출근 시간 선택
- ✅ 퇴근 시간 선택
- ✅ 사유 입력
- ✅ 승인 요청 제출
- ✅ 유효성 검증 (시간 순서, 과거 날짜 등)

**개선 가능 항목**:
- [ ] DatePicker 컴포넌트로 개선 (현재 기본 컴포넌트)
- [ ] TimePicker 컴포넌트로 개선
- [ ] 사유 템플릿 제공 (지각, 조퇴, GPS 오류 등)
- [ ] 첨부파일 추가 (증빙 서류)

**예상 개선 시간**: 3-4시간

---

### 3. EditRequestScreen.tsx ❌ (미구현 - 필수)
**파일 위치**: `front/src/screens/attendance/EditRequestScreen.tsx`

**구현 필요 기능**:
- [ ] 기존 근태 목록 조회 (월별 or 전체)
- [ ] 근태 항목 선택
- [ ] 수정 내용 입력
  - 출근 시간 수정
  - 퇴근 시간 수정
  - 수정 사유 입력
- [ ] 수정 요청 제출
- [ ] 승인/거부 상태 표시
- [ ] 거부 사유 표시 (관리자 피드백)

**예상 구현 시간**: 6-8시간

**우선순위**: 🔴 높음 (필수 기능)

**화면 구조**:
```
┌─────────────────────────────────────────┐
│ Header: 근태 수정 요청                  │
├─────────────────────────────────────────┤
│ 근태 목록 (최근 30일)                   │
│ ┌─────────────────────────────────────┐ │
│ │ 12/25 (수) 09:00 - 18:00           │ │
│ │ [수정 요청]                         │ │
│ ├─────────────────────────────────────┤ │
│ │ 12/24 (화) 09:15 - 18:00           │ │
│ │ [수정 요청] (승인 대기)             │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘

// 수정 요청 화면 (선택 후)
┌─────────────────────────────────────────┐
│ Header: 근태 수정 요청                  │
├─────────────────────────────────────────┤
│ 날짜: 2024-12-25 (수)                   │
├─────────────────────────────────────────┤
│ 기존 출근 시간: 09:00                   │
│ 수정 출근 시간: [TimePicker]            │
├─────────────────────────────────────────┤
│ 기존 퇴근 시간: 18:00                   │
│ 수정 퇴근 시간: [TimePicker]            │
├─────────────────────────────────────────┤
│ 수정 사유: [TextArea]                   │
│ (필수 입력)                             │
├─────────────────────────────────────────┤
│ [제출] 버튼                             │
└─────────────────────────────────────────┘
```

---

### 4. AttendanceHistoryScreen.tsx ❌ (미구현 - 선택사항)
**파일 위치**: `front/src/screens/attendance/AttendanceHistoryScreen.tsx`

**구현 필요 기능**:
- [ ] 월별 근태 목록 조회
- [ ] 필터링 (정상 출근, 수동 입력, 수정됨)
- [ ] 통계 표시
  - 총 근무일수
  - 총 근무시간
  - 평균 근무시간
- [ ] 상세 내역 표시 (출근/퇴근 시간, 근무시간)
- [ ] 엑셀 다운로드 (선택사항)

**예상 구현 시간**: 4-6시간

**우선순위**: 중간

---

## 🔧 컴포넌트 상세

### 1. BigAttendanceButton.tsx ✅
**파일 위치**: `front/src/components/attendance/BigAttendanceButton.tsx`

**구현된 기능**:
- ✅ 상태별 스타일 변경 (출근/퇴근/완료)
- ✅ 로딩 상태 표시
- ✅ 비활성화 상태 처리
- ✅ 크기: wp(50) x wp(50) (반응형)

**개선 가능 항목**:
- [ ] 애니메이션 추가 (누를 때)
- [ ] 햅틱 피드백
- [ ] 아이콘 추가

---

### 2. CurrentTimeDisplay.tsx ✅
**파일 위치**: `front/src/components/attendance/CurrentTimeDisplay.tsx`

**구현된 기능**:
- ✅ 현재 시간 표시 (HH:mm:ss)
- ✅ 현재 날짜 표시
- ✅ 실시간 업데이트 (1초마다)

**개선 가능 항목**:
- [ ] 다양한 포맷 옵션
- [ ] 요일 표시

---

### 3. LocationStatusCard.tsx ✅
**파일 위치**: `front/src/components/attendance/LocationStatusCard.tsx`

**구현된 기능**:
- ✅ 현재 거리 표시
- ✅ GPS 상태 표시 (가능/불가능)
- ✅ 새로고침 버튼

**개선 필요 사항**:
- [ ] GPS 정확도 표시 (high/medium/low)
- [ ] 위치 서비스 비활성화 시 안내
- [ ] 지도 미리보기 (선택사항)

---

### 4. TodayWorkInfoCard.tsx ✅
**파일 위치**: `front/src/components/attendance/TodayWorkInfoCard.tsx`

**구현된 기능**:
- ✅ 출근 시간 표시
- ✅ 퇴근 시간 표시
- ✅ 근무 시간 계산 및 표시
- ✅ 일급 계산 및 표시

**개선 가능 항목**:
- [ ] 타임라인 바 추가
- [ ] 예정 근무 시간과 비교

---

### 5. EarlyClockInAlert.tsx ✅
**파일 위치**: `front/src/components/attendance/EarlyClockInAlert.tsx`

**구현된 기능**:
- ✅ 20시 이전 출근 시 알림 표시
- ✅ 급여 계산 기준 안내 (20시부터)

**개선 가능 항목**:
- [ ] 애니메이션 추가
- [ ] 닫기 버튼
- [ ] "다시 보지 않기" 옵션

---

## 🎯 GPS 기능 상세

### 거리 계산 로직
```typescript
// Haversine 공식
const calculateDistance = (
  lat1: number,
  lon1: number,
  lat2: number,
  lon2: number
): number => {
  const R = 6371000; // 지구 반지름 (미터)
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  
  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(toRad(lat1)) *
      Math.cos(toRad(lat2)) *
      Math.sin(dLon / 2) *
      Math.sin(dLon / 2);
  
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c; // 미터 단위
};
```

### GPS 허용 범위
- 기본 허용 반경: **50m**
- 사업장별로 설정 가능 (20m ~ 500m)
- 범위 내: 출퇴근 가능 (초록색)
- 범위 밖: 출퇴근 불가 (빨간색)

### GPS 정확도
- `high` (< 10m): 매우 정확
- `medium` (10m ~ 50m): 보통
- `low` (> 50m): 낮음 (경고 표시)

---

## 🕐 20시 기준 급여 계산

### 규칙
1. **20시 이전 출근**: 급여는 **20시부터** 계산
2. **20시 이후 출근**: 급여는 **실제 출근 시간부터** 계산

### 예시
| 출근 시간 | 퇴근 시간 | 급여 계산 시간 | 근무 시간 |
|-----------|-----------|----------------|-----------|
| 19:00 | 23:00 | 20:00 ~ 23:00 | 3시간 |
| 20:00 | 00:00 | 20:00 ~ 00:00 | 4시간 |
| 21:00 | 01:00 | 21:00 ~ 01:00 | 4시간 |
| 18:30 | 22:30 | 20:00 ~ 22:30 | 2.5시간 |

### 알림 표시
- 20시 이전 출근 시 `EarlyClockInAlert` 표시
- "급여는 20시부터 계산됩니다" 안내

---

## 🔄 출퇴근 플로우

### 출근 플로우
```
출퇴근 화면
  │
  ├─→ GPS 위치 확인
  │     │
  │     ├─→ 범위 내 (50m 이내)
  │     │     │
  │     │     └─→ [출근하기] 버튼 활성화
  │     │           │
  │     │           ├─→ 버튼 터치
  │     │           │     │
  │     │           │     └─→ API 호출 → 성공 → 토스트 표시
  │     │           │
  │     │           └─→ 20시 이전인 경우 → 알림 표시
  │     │
  │     └─→ 범위 밖 (50m 초과)
  │           │
  │           └─→ [출근하기] 버튼 비활성화 → 안내 메시지
  │
  └─→ GPS 오류 or 위치 서비스 비활성화
        │
        └─→ 수동 입력 안내 → [수동 입력] 버튼
```

### 퇴근 플로우
```
출퇴근 화면 (출근 완료 상태)
  │
  ├─→ GPS 위치 확인
  │     │
  │     ├─→ 범위 내 → [퇴근하기] 버튼 활성화
  │     │     │
  │     │     └─→ 버튼 터치 → API 호출 → 성공
  │     │           │
  │     │           └─→ 오늘 근무 정보 업데이트
  │     │                 (근무 시간, 일급 표시)
  │     │
  │     └─→ 범위 밖 → 비활성화 → 안내
  │
  └─→ GPS 오류 → 수동 입력 안내
```

---

## 🛠️ 필요한 작업

### 1. EditRequestScreen 구현 (필수)
**우선순위**: 🔴 최우선

- [ ] EditRequestScreen.tsx 생성
- [ ] 근태 목록 조회 API 연동
- [ ] 수정 요청 폼 구현
- [ ] 수정 요청 API 연동
- [ ] MainNavigator에 라우트 추가

**예상 시간**: 6-8시간

---

### 2. GPS 정확도 표시 및 개선
**우선순위**: 🔴 높음

- [ ] GPS 정확도 표시 (LocationStatusCard)
- [ ] 위치 서비스 비활성화 시 안내 강화
- [ ] 위치 권한 재요청 플로우

**예상 시간**: 3-4시간

---

### 3. AttendanceHistoryScreen 구현 (선택사항)
**우선순위**: 중간

- [ ] AttendanceHistoryScreen.tsx 생성
- [ ] 월별 근태 조회 API 연동
- [ ] 필터링 및 통계 기능
- [ ] MainNavigator에 라우트 추가

**예상 시간**: 4-6시간

---

### 4. UX 개선
**우선순위**: 중간

- [ ] 출퇴근 성공 애니메이션
- [ ] 햅틱 피드백 추가
- [ ] 로딩 오버레이 (전체 화면)
- [ ] 에러 처리 강화

**예상 시간**: 3-4시간

---

## 🧪 테스트 체크리스트

### 기능 테스트
- [x] 출근 (GPS 범위 내)
- [x] 퇴근 (GPS 범위 내)
- [x] GPS 거리 계산
- [x] 20시 이전 출근 알림
- [x] 수동 근태 입력
- [ ] 근태 수정 요청
- [ ] 근태 내역 조회

### GPS 테스트
- [x] 위치 권한 요청
- [x] 현재 위치 획득
- [x] 거리 계산 정확도
- [x] GPS 범위 판단 (50m)
- [ ] GPS 정확도 표시
- [ ] 위치 서비스 비활성화 시 처리

### UI/UX 테스트
- [x] 출퇴근 버튼 상태 변경
- [x] 로딩 상태 표시
- [x] 에러 메시지 표시
- [ ] 애니메이션 (출퇴근 성공)
- [ ] 햅틱 피드백

---

## 📚 참고 문서

| 문서 | 경로 | 용도 |
|------|------|------|
| 출퇴근 메인 명세 | `docs/05_screens/03_attendance/attendance-main.md` | 화면 상세 |
| 수동 입력 명세 | `docs/05_screens/03_attendance/manual-input.md` | 수동 입력 상세 |
| 수정 요청 명세 | `docs/05_screens/03_attendance/edit-request.md` | 수정 요청 상세 |

---

## ⏭️ 다음 단계

출퇴근 도메인 완료 후:
1. → [04-calendar.md](./04-calendar.md) (캘린더 - 근무 내역 조회)
2. → [11-payroll.md](./11-payroll.md) (급여 - 출퇴근 기반)
3. → [09-admin.md](./09-admin.md) (관리자 - 승인 처리)

---

## 💡 참고 사항

- 출퇴근 도메인은 **핵심 기능 80% 완료**
- EditRequestScreen은 **필수 구현** 항목
- GPS 정확도 표시는 UX 개선에 중요
- AttendanceHistoryScreen은 선택사항이지만 사용자 편의성 향상
- 20시 기준 급여 계산 로직은 이미 구현되어 있음

