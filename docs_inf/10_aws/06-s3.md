# 6. Amazon S3 ì„¤ì •

> íŒŒì¼ ì €ì¥ì†Œë¥¼ ìƒì„±í•˜ê³  ì„¤ì •í•©ë‹ˆë‹¤.

## ğŸ“ ë‹¨ê³„ë³„ ê°€ì´ë“œ

### 6.1 S3 ë²„í‚· ìƒì„±

AWS Console â†’ S3 â†’ ë²„í‚· ë§Œë“¤ê¸°

**1. ë²„í‚· ê¸°ë³¸ ì„¤ì •**

```
ë²„í‚· ì´ë¦„: biz-one-storage-{random-suffix}
ë¦¬ì „: ì•„ì‹œì•„ íƒœí‰ì–‘(ì„œìš¸) ap-northeast-2
```

âš ï¸ ë²„í‚· ì´ë¦„ì€ ì „ ì„¸ê³„ì ìœ¼ë¡œ ê³ ìœ í•´ì•¼ í•©ë‹ˆë‹¤.

**2. ê°ì²´ ì†Œìœ ê¶Œ**

```
â—‹ ACL ë¹„í™œì„±í™” (ê¶Œì¥)
```

**3. í¼ë¸”ë¦­ ì•¡ì„¸ìŠ¤ ì°¨ë‹¨ ì„¤ì •**

```
âœ… ëª¨ë“  í¼ë¸”ë¦­ ì•¡ì„¸ìŠ¤ ì°¨ë‹¨ (ê¶Œì¥)
```

**4. ë²„í‚· ë²„ì „ ê´€ë¦¬**

```
â—‹ ë¹„í™œì„±í™” (ë¹„ìš© ì ˆì•½)
```

**5. ì•”í˜¸í™”**

```
ì•”í˜¸í™” ìœ í˜•: SSE-S3 (Amazon S3 ê´€ë¦¬í˜• í‚¤)
ë²„í‚· í‚¤: âœ… í™œì„±í™”
```

### 6.2 ë²„í‚· í´ë” êµ¬ì¡°

```
biz-one-storage-xxxxx/
â”œâ”€â”€ profiles/                       # í”„ë¡œí•„ ì‚¬ì§„
â”‚   â””â”€â”€ {userId}/
â”‚       â””â”€â”€ profile.jpg
â”‚
â”œâ”€â”€ workplaces/                     # ì‚¬ì—…ì¥ë³„ íŒŒì¼
â”‚   â””â”€â”€ {workplaceId}/
â”‚       â”œâ”€â”€ announcements/          # ê³µì§€ì‚¬í•­ ì²¨ë¶€íŒŒì¼
â”‚       â”‚   â””â”€â”€ {announcementId}/
â”‚       â”‚       â””â”€â”€ {filename}
â”‚       â”œâ”€â”€ chat/                   # ì±„íŒ… ì²¨ë¶€íŒŒì¼
â”‚       â”‚   â””â”€â”€ {chatRoomId}/
â”‚       â”‚       â””â”€â”€ {filename}
â”‚       â”œâ”€â”€ contracts/              # ê·¼ë¡œê³„ì•½ì„œ PDF
â”‚       â”‚   â””â”€â”€ {contractId}/
â”‚       â”‚       â””â”€â”€ contract.pdf
â”‚       â””â”€â”€ signatures/             # ì „ìì„œëª… ì´ë¯¸ì§€
â”‚           â””â”€â”€ {contractId}/
â”‚               â”œâ”€â”€ admin_signature.png
â”‚               â””â”€â”€ employee_signature.png
â”‚
â””â”€â”€ payslips/                       # ê¸‰ì—¬ëª…ì„¸ì„œ PDF
    â””â”€â”€ {workplaceId}/
        â””â”€â”€ {userId}/
            â””â”€â”€ {year}-{month}.pdf
```

### 6.3 CORS ì„¤ì •

S3 ë²„í‚· â†’ ê¶Œí•œ â†’ CORS(Cross-origin ë¦¬ì†ŒìŠ¤ ê³µìœ ):

```json
[
  {
    "AllowedHeaders": ["*"],
    "AllowedMethods": ["GET", "PUT", "POST", "DELETE", "HEAD"],
    "AllowedOrigins": ["*"],
    "ExposeHeaders": ["ETag", "x-amz-meta-custom-header"]
  }
]
```

### 6.4 ë²„í‚· ì •ì±… ì„¤ì •

S3 ë²„í‚· â†’ ê¶Œí•œ â†’ ë²„í‚· ì •ì±…:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowCognitoUserAccess",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::{ACCOUNT_ID}:role/Cognito_biz-one-identity-poolAuth_Role"
      },
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject"
      ],
      "Resource": "arn:aws:s3:::biz-one-storage-xxxxx/*"
    }
  ]
}
```

### 6.5 S3 ì„œë¹„ìŠ¤ êµ¬í˜„

`src/services/s3Service.ts`:

```typescript
import { uploadData, downloadData, remove, getUrl } from 'aws-amplify/storage';

// íŒŒì¼ ì—…ë¡œë“œ
export const uploadFile = async (
  key: string,
  file: Blob | File,
  options?: {
    contentType?: string;
    onProgress?: (progress: { transferredBytes: number; totalBytes: number }) => void;
  }
) => {
  try {
    const result = await uploadData({
      key,
      data: file,
      options: {
        contentType: options?.contentType,
        onProgress: options?.onProgress,
      },
    }).result;
    return result;
  } catch (error) {
    console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
    throw error;
  }
};

// React Nativeì—ì„œ ë¡œì»¬ íŒŒì¼ ì—…ë¡œë“œ
export const uploadLocalFile = async (
  key: string,
  localUri: string,
  contentType: string,
  onProgress?: (progress: number) => void
) => {
  try {
    // ë¡œì»¬ íŒŒì¼ì„ Blobìœ¼ë¡œ ë³€í™˜
    const response = await fetch(localUri);
    const blob = await response.blob();
    
    const result = await uploadData({
      key,
      data: blob,
      options: {
        contentType,
        onProgress: (event) => {
          const progress = (event.transferredBytes / event.totalBytes) * 100;
          onProgress?.(progress);
        },
      },
    }).result;
    
    return result;
  } catch (error) {
    console.error('ë¡œì»¬ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
    throw error;
  }
};

// íŒŒì¼ ë‹¤ìš´ë¡œë“œ URL ê°€ì ¸ì˜¤ê¸°
export const getDownloadUrl = async (key: string) => {
  try {
    const result = await getUrl({
      key,
      options: {
        expiresIn: 3600, // 1ì‹œê°„
      },
    });
    return result.url.toString();
  } catch (error) {
    console.error('ë‹¤ìš´ë¡œë“œ URL ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
    throw error;
  }
};

// íŒŒì¼ ì‚­ì œ
export const deleteFile = async (key: string) => {
  try {
    await remove({ key });
  } catch (error) {
    console.error('íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨:', error);
    throw error;
  }
};

// í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ
export const uploadProfileImage = async (
  userId: string,
  localUri: string,
  onProgress?: (progress: number) => void
) => {
  const key = `profiles/${userId}/profile.jpg`;
  await uploadLocalFile(key, localUri, 'image/jpeg', onProgress);
  return getDownloadUrl(key);
};

// ê³µì§€ì‚¬í•­ ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ
export const uploadAnnouncementAttachment = async (
  workplaceId: string,
  announcementId: string,
  fileName: string,
  localUri: string,
  contentType: string,
  onProgress?: (progress: number) => void
) => {
  const key = `workplaces/${workplaceId}/announcements/${announcementId}/${fileName}`;
  await uploadLocalFile(key, localUri, contentType, onProgress);
  return {
    key,
    url: await getDownloadUrl(key),
  };
};

// ì±„íŒ… ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ
export const uploadChatAttachment = async (
  workplaceId: string,
  chatRoomId: string,
  fileName: string,
  localUri: string,
  contentType: string,
  onProgress?: (progress: number) => void
) => {
  const key = `workplaces/${workplaceId}/chat/${chatRoomId}/${fileName}`;
  await uploadLocalFile(key, localUri, contentType, onProgress);
  return {
    key,
    url: await getDownloadUrl(key),
  };
};

// ê³„ì•½ì„œ PDF ì—…ë¡œë“œ
export const uploadContractPdf = async (
  workplaceId: string,
  contractId: string,
  pdfUri: string,
  onProgress?: (progress: number) => void
) => {
  const key = `workplaces/${workplaceId}/contracts/${contractId}/contract.pdf`;
  await uploadLocalFile(key, pdfUri, 'application/pdf', onProgress);
  return getDownloadUrl(key);
};

// ì „ìì„œëª… ì´ë¯¸ì§€ ì—…ë¡œë“œ
export const uploadSignature = async (
  workplaceId: string,
  contractId: string,
  signatureType: 'admin' | 'employee',
  signatureUri: string
) => {
  const key = `workplaces/${workplaceId}/signatures/${contractId}/${signatureType}_signature.png`;
  await uploadLocalFile(key, signatureUri, 'image/png');
  return getDownloadUrl(key);
};

// ê¸‰ì—¬ëª…ì„¸ì„œ PDF ì—…ë¡œë“œ
export const uploadPayslipPdf = async (
  workplaceId: string,
  userId: string,
  year: number,
  month: number,
  pdfUri: string
) => {
  const key = `payslips/${workplaceId}/${userId}/${year}-${String(month).padStart(2, '0')}.pdf`;
  await uploadLocalFile(key, pdfUri, 'application/pdf');
  return getDownloadUrl(key);
};

export const s3Service = {
  uploadFile,
  uploadLocalFile,
  getDownloadUrl,
  deleteFile,
  uploadProfileImage,
  uploadAnnouncementAttachment,
  uploadChatAttachment,
  uploadContractPdf,
  uploadSignature,
  uploadPayslipPdf,
};
```

### 6.6 íŒŒì¼ í¬ê¸° ì œí•œ

| íŒŒì¼ ìœ í˜• | ìµœëŒ€ í¬ê¸° |
|-----------|----------|
| í”„ë¡œí•„ ì´ë¯¸ì§€ | 10MB |
| ê³µì§€ì‚¬í•­ ì²¨ë¶€íŒŒì¼ | 10MB |
| ì±„íŒ… ì²¨ë¶€íŒŒì¼ | 100MB |
| ê³„ì•½ì„œ PDF | 10MB |
| ì „ìì„œëª… ì´ë¯¸ì§€ | 1MB |
| ê¸‰ì—¬ëª…ì„¸ì„œ PDF | 10MB |

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

S3 ì„¤ì • ì™„ë£Œ í™•ì¸:

- [ ] S3 ë²„í‚· ìƒì„±ë¨
- [ ] CORS ì„¤ì •ë¨
- [ ] ë²„í‚· ì •ì±… ì„¤ì •ë¨ (ë˜ëŠ” Cognito IAM ì—­í• ì— ê¶Œí•œ ë¶€ì—¬)
- [ ] ì•± ì½”ë“œì—ì„œ S3 ì—°ë™ë¨

## ğŸ“‹ ë²„í‚· ì •ë³´ ê¸°ë¡

```
ë²„í‚· ì´ë¦„: biz-one-storage-xxxxx
ë¦¬ì „: ap-northeast-2
ARN: arn:aws:s3:::biz-one-storage-xxxxx
```

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

**ë‹¤ìŒ**: [7. Amazon SNS & Pinpoint (í‘¸ì‹œ ì•Œë¦¼)](./07-push-notification.md)

---

## â“ ë¬¸ì œ í•´ê²°

**Q: ì—…ë¡œë“œ ì‹¤íŒ¨ - Access Denied**
- A: IAM ì—­í• ì— S3 ê¶Œí•œ í™•ì¸
- A: ë²„í‚· ì •ì±… í™•ì¸

**Q: íŒŒì¼ URLì´ ë§Œë£Œë¨**
- A: presigned URLì€ ê¸°ë³¸ 1ì‹œê°„ ë§Œë£Œ
- A: ì˜êµ¬ URLì´ í•„ìš”í•˜ë©´ CloudFront ì‚¬ìš© ê³ ë ¤

**Q: ì—…ë¡œë“œ ì†ë„ê°€ ëŠë¦¼**
- A: multipart upload ì‚¬ìš© (ëŒ€ìš©ëŸ‰ íŒŒì¼)
- A: ë¦¬ì „ ì„¤ì • í™•ì¸ (ì„œìš¸ ë¦¬ì „ ê¶Œì¥)

