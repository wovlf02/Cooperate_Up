// Prisma ì„¤ì •
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ì‚¬ìš©ì (User)
// ============================================
model User {
  id       String   @id @default(cuid())
  email    String   @unique
  password String? // null for OAuth users
  name     String?
  avatar   String?
  bio      String?
  provider Provider @default(CREDENTIALS)
  role     UserRole @default(USER)

  // ì†Œì…œ ë¡œê·¸ì¸
  googleId String? @unique
  githubId String? @unique

  // ìƒíƒœ
  status         UserStatus @default(ACTIVE)
  suspendedUntil DateTime?
  suspendReason  String?

  // í™œë™ ì œí•œ
  restrictedUntil   DateTime?
  restrictedActions String[]  @default([])

  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // ê´€ê³„
  ownedStudies       Study[]             @relation("StudyOwner")
  studyMembers       StudyMember[]
  messages           Message[]
  notifications      Notification[]
  tasks              Task[]
  reports            Report[]
  createdNotices     Notice[]
  uploadedFiles      File[]              @relation("FileUploader")
  createdEvents      Event[]             @relation("EventCreator")
  createdStudyTasks  StudyTask[]         @relation("StudyTaskCreator")
  assignedStudyTasks StudyTaskAssignee[] @relation("TaskAssignee")

  // ê·¸ë£¹ ê´€ë ¨
  createdGroups   Group[]       @relation("GroupCreator")
  groupMembers    GroupMember[]
  sentInvites     GroupInvite[] @relation("GroupInviter")
  receivedInvites GroupInvite[] @relation("GroupInvitee")

  // ê´€ë¦¬ì ê´€ë ¨
  sanctions        Sanction[] @relation("UserSanctions")
  receivedWarnings Warning[]
  adminLogs        AdminLog[] @relation("AdminActions")
  adminRole        AdminRole?

  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@index([lastLoginAt])
}

enum Provider {
  CREDENTIALS
  GOOGLE
  GITHUB
}

enum UserRole {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

// ============================================
// ìŠ¤í„°ë”” (Study)
// ============================================
model Study {
  id          String  @id @default(cuid())
  ownerId     String
  name        String
  emoji       String  @default("ğŸ“š")
  description String  @db.Text
  category    String
  subCategory String?

  // ì„¤ì •
  maxMembers   Int     @default(20)
  isPublic     Boolean @default(true)
  autoApprove  Boolean @default(true)
  isRecruiting Boolean @default(true)

  // í‰ê°€
  rating      Float? @default(0)
  reviewCount Int?   @default(0)

  // ë©”íƒ€
  tags       String[] // PostgreSQL array
  inviteCode String   @unique @default(cuid())

  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ê´€ê³„
  owner      User          @relation("StudyOwner", fields: [ownerId], references: [id])
  members    StudyMember[]
  messages   Message[]
  notices    Notice[]
  files      File[]
  events     Event[]
  tasks      Task[]
  studyTasks StudyTask[]

  @@index([category])
  @@index([isPublic, isRecruiting])
  @@index([ownerId])
  @@index([rating])
}

// ============================================
// ìŠ¤í„°ë”” ë©¤ë²„ (StudyMember)
// ============================================
model StudyMember {
  id      String       @id @default(cuid())
  studyId String
  userId  String
  role    MemberRole   @default(MEMBER)
  status  MemberStatus @default(PENDING)

  // ê°€ì… ì •ë³´
  introduction String? @db.Text
  motivation   String?
  level        String?

  // íƒ€ì„ìŠ¤íƒ¬í”„
  joinedAt   DateTime  @default(now())
  approvedAt DateTime?

  // ê´€ê³„
  study Study @relation(fields: [studyId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([studyId, userId])
  @@index([userId])
  @@index([status])
  @@index([studyId, status]) // ìŠ¤í„°ë”” ë©¤ë²„ í•„í„°ë§ ìµœì í™”
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
}

enum MemberStatus {
  PENDING
  ACTIVE
  KICKED
  LEFT
}

// ============================================
// ì±„íŒ… ë©”ì‹œì§€ (Message)
// ============================================
model Message {
  id      String  @id @default(cuid())
  studyId String
  userId  String
  content String  @db.Text
  fileId  String?

  // ì½ìŒ ì²˜ë¦¬
  readers String[] // User IDs array

  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ê´€ê³„
  study Study @relation(fields: [studyId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id])
  file  File? @relation(fields: [fileId], references: [id])

  @@index([studyId, createdAt])
}

// ============================================
// ê³µì§€ì‚¬í•­ (Notice)
// ============================================
model Notice {
  id       String @id @default(cuid())
  studyId  String
  authorId String
  title    String
  content  String @db.Text

  // ìƒíƒœ
  isPinned    Boolean @default(false)
  isImportant Boolean @default(false)

  // í†µê³„
  views Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  attachments NoticeFile[] // ê³µì§€ì‚¬í•­ì— ì²¨ë¶€ëœ íŒŒì¼ë“¤

  study  Study @relation(fields: [studyId], references: [id], onDelete: Cascade)
  author User  @relation(fields: [authorId], references: [id])

  @@index([studyId, isPinned, createdAt])
  @@index([authorId])
}

// ============================================
// ê³µì§€ì‚¬í•­ íŒŒì¼ (NoticeFile)
// ============================================
model NoticeFile {
  id        String   @id @default(cuid())
  noticeId  String
  fileId    String
  createdAt DateTime @default(now())

  notice Notice @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  file   File   @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@unique([noticeId, fileId]) // A file can only be attached once to a specific notice
  @@index([noticeId])
  @@index([fileId])
}

// ============================================
// íŒŒì¼ (File)
// ============================================
model File {
  id         String  @id @default(cuid())
  studyId    String
  uploaderId String
  name       String
  size       Int
  type       String
  url        String
  folderId   String?

  downloads Int @default(0)

  createdAt DateTime @default(now())

  study       Study        @relation(fields: [studyId], references: [id], onDelete: Cascade)
  uploader    User         @relation("FileUploader", fields: [uploaderId], references: [id])
  messages    Message[]
  noticeFiles NoticeFile[]

  @@index([studyId, folderId])
  @@index([uploaderId])
}

// ============================================
// ìº˜ë¦°ë” ì¼ì • (Event)
// ============================================
model Event {
  id          String   @id @default(cuid())
  studyId     String
  createdById String
  title       String
  date        DateTime @db.Date
  startTime   String
  endTime     String
  location    String?
  color       String   @default("#6366F1")

  createdAt DateTime @default(now())

  study     Study @relation(fields: [studyId], references: [id], onDelete: Cascade)
  createdBy User  @relation("EventCreator", fields: [createdById], references: [id])

  @@index([studyId, date])
  @@index([createdById])
}

// ============================================
// í• ì¼ (Task) - ê°œì¸ìš©
// ============================================
model Task {
  id          String     @id @default(cuid())
  studyId     String?
  userId      String
  title       String
  description String?    @db.Text
  status      TaskStatus @default(TODO)
  priority    Priority   @default(MEDIUM)
  dueDate     DateTime?

  completed   Boolean   @default(false)
  completedAt DateTime?

  createdAt DateTime @default(now())

  user  User   @relation(fields: [userId], references: [id])
  study Study? @relation(fields: [studyId], references: [id], onDelete: Cascade)

  @@index([userId, completed])
  @@index([studyId, status])
}

// ============================================
// ìŠ¤í„°ë”” í• ì¼ (StudyTask) - ìŠ¤í„°ë”” ê³µìœ ìš©
// ============================================
model StudyTask {
  id          String     @id @default(cuid())
  studyId     String
  createdById String
  title       String
  description String?    @db.Text
  status      TaskStatus @default(TODO)
  priority    Priority   @default(MEDIUM)
  dueDate     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  study     Study               @relation(fields: [studyId], references: [id], onDelete: Cascade)
  createdBy User                @relation("StudyTaskCreator", fields: [createdById], references: [id])
  assignees StudyTaskAssignee[]

  @@index([studyId, status])
  @@index([createdById])
}

model StudyTaskAssignee {
  id     String @id @default(cuid())
  taskId String
  userId String

  assignedAt DateTime @default(now())

  task StudyTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User      @relation("TaskAssignee", fields: [userId], references: [id])

  @@unique([taskId, userId])
  @@index([userId])
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ============================================
// ì•Œë¦¼ (Notification)
// ============================================
model Notification {
  id         String           @id @default(cuid())
  userId     String
  type       NotificationType
  studyId    String?
  studyName  String?
  studyEmoji String?
  message    String
  data       Json? // ì¶”ê°€ ë°ì´í„°

  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
}

enum NotificationType {
  JOIN_APPROVED
  NOTICE
  FILE
  EVENT
  TASK
  MEMBER
  KICK
  CHAT
}

// ============================================
// ì‹ ê³  (Report)
// ============================================
model Report {
  id         String     @id @default(cuid())
  reporterId String
  targetType TargetType
  targetId   String
  targetName String? // ì‹ ê³  ëŒ€ìƒ ì´ë¦„ (ìºì‹œ)
  type       ReportType
  reason     String     @db.Text
  evidence   Json? // ì¦ê±° ìë£Œ

  status   ReportStatus @default(PENDING)
  priority Priority     @default(MEDIUM)

  // ì²˜ë¦¬
  processedBy String?
  processedAt DateTime?
  resolution  String?   @db.Text

  createdAt DateTime @default(now())

  reporter User @relation(fields: [reporterId], references: [id])

  @@index([status, priority, createdAt])
  @@index([targetType, targetId])
}

enum TargetType {
  USER
  STUDY
  MESSAGE
}

enum ReportType {
  SPAM
  HARASSMENT
  INAPPROPRIATE
  COPYRIGHT
  OTHER
}

enum ReportStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  REJECTED
}

// ============================================
// ê´€ë¦¬ì ì‹œìŠ¤í…œ (Admin System)
// ============================================

// ê²½ê³  ì‹œìŠ¤í…œ
model Warning {
  id             String          @id @default(cuid())
  userId         String
  adminId        String
  reason         String          @db.Text
  severity       WarningSeverity @default(NORMAL)
  relatedContent String? // URL or ID
  expiresAt      DateTime? // ê²½ê³  ìœ íš¨ ê¸°ê°„
  createdAt      DateTime        @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([severity, createdAt])
  @@index([userId, severity, createdAt]) // ë³µí•© ì¡°íšŒ ìµœì í™”
}

enum WarningSeverity {
  MINOR // ê²½ë¯¸í•œ ìœ„ë°˜
  NORMAL // ì¼ë°˜ ìœ„ë°˜
  SERIOUS // ì‹¬ê°í•œ ìœ„ë°˜
  CRITICAL // ì¹˜ëª…ì  ìœ„ë°˜
}

// ì œì¬ ì´ë ¥
model Sanction {
  id              String       @id @default(cuid())
  userId          String
  adminId         String
  type            SanctionType
  reason          String       @db.Text
  duration        String? // "1d", "3d", "7d", "30d", "permanent"
  expiresAt       DateTime?
  relatedReportId String?
  metadata        String?      @db.Text // JSON í˜•ì‹ì˜ ì¶”ê°€ ë°ì´í„°

  // í•´ì œ ì •ë³´
  isActive        Boolean   @default(true)
  unsuspendedBy   String?
  unsuspendReason String?
  unsuspendedAt   DateTime?

  createdAt DateTime @default(now())

  user User @relation("UserSanctions", fields: [userId], references: [id])

  @@index([userId, type, createdAt])
  @@index([userId, isActive, expiresAt]) // í™œì„± ì œì¬ ì¡°íšŒ ìµœì í™”
  @@index([isActive, expiresAt])
}

enum SanctionType {
  WARNING // ê²½ê³ 
  CHAT_BAN // ì±„íŒ… ê¸ˆì§€
  STUDY_CREATE_BAN // ìŠ¤í„°ë”” ìƒì„± ê¸ˆì§€
  FILE_UPLOAD_BAN // íŒŒì¼ ì—…ë¡œë“œ ê¸ˆì§€
  RESTRICTION // í™œë™ ì œí•œ
  SUSPENSION // ê³„ì • ì •ì§€
  PERMANENT_BAN // ì˜êµ¬ ì •ì§€
}

// ê´€ë¦¬ì í™œë™ ë¡œê·¸
model AdminLog {
  id         String      @id @default(cuid())
  adminId    String
  action     AdminAction
  targetType String? // "User", "Study", "Report"
  targetId   String?

  // ë³€ê²½ ë‚´ìš©
  before Json?
  after  Json?
  reason String? @db.Text

  // ë©”íƒ€ ì •ë³´
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  admin User @relation("AdminActions", fields: [adminId], references: [id])

  @@index([adminId, createdAt])
  @@index([action, createdAt])
  @@index([targetType, targetId])
}

enum AdminAction {
  // ì‚¬ìš©ì ê´€ë¦¬
  USER_VIEW
  USER_SEARCH
  USER_WARN
  USER_SUSPEND
  USER_UNSUSPEND
  USER_DELETE
  USER_RESTORE
  USER_UPDATE

  // ìŠ¤í„°ë”” ê´€ë¦¬
  STUDY_VIEW
  STUDY_HIDE
  STUDY_UNHIDE
  STUDY_CLOSE
  STUDY_REOPEN
  STUDY_DELETE
  STUDY_RECOMMEND

  // ì‹ ê³  ì²˜ë¦¬
  REPORT_VIEW
  REPORT_ASSIGN
  REPORT_RESOLVE
  REPORT_REJECT

  // ì½˜í…ì¸  ê´€ë¦¬
  CONTENT_DELETE
  CONTENT_RESTORE

  // ì‹œìŠ¤í…œ ì„¤ì •
  SETTINGS_VIEW
  SETTINGS_UPDATE
  SETTINGS_CACHE_CLEAR

  // ë¶„ì„ ë° í†µê³„
  ANALYTICS_VIEW
  ANALYTICS_EXPORT

  // ê°ì‚¬ ë¡œê·¸
  AUDIT_VIEW
  AUDIT_EXPORT
}

// ê´€ë¦¬ì ì—­í•  ë° ê¶Œí•œ
model AdminRole {
  id          String        @id @default(cuid())
  userId      String        @unique
  role        AdminRoleType
  permissions Json // ì„¸ë¶€ ê¶Œí•œ JSON
  grantedBy   String
  grantedAt   DateTime      @default(now())
  expiresAt   DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([role])
}

enum AdminRoleType {
  VIEWER // ì¡°íšŒë§Œ ê°€ëŠ¥
  MODERATOR // ì½˜í…ì¸  ëª¨ë”ë ˆì´ì…˜
  ADMIN // ì‚¬ìš©ì/ìŠ¤í„°ë”” ê´€ë¦¬
  SUPER_ADMIN // ëª¨ë“  ê¶Œí•œ
}

// ============================================
// ê·¸ë£¹ (Group)
// ============================================
model Group {
  id          String  @id @default(cuid())
  name        String
  description String? @db.Text
  category    String  @default("etc")
  imageUrl    String?

  // ê·¸ë£¹ ì„¤ì •
  isPublic     Boolean @default(true)
  maxMembers   Int     @default(50)
  isRecruiting Boolean @default(true)

  // ë©”íƒ€
  createdBy String
  deletedAt DateTime?

  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ê´€ê³„
  creator User          @relation("GroupCreator", fields: [createdBy], references: [id])
  members GroupMember[]
  invites GroupInvite[]

  @@index([category])
  @@index([isPublic, isRecruiting])
  @@index([createdBy])
}

// ============================================
// ê·¸ë£¹ ë©¤ë²„ (GroupMember)
// ============================================
model GroupMember {
  id      String            @id @default(cuid())
  groupId String
  userId  String
  role    GroupMemberRole   @default(MEMBER)
  status  GroupMemberStatus @default(ACTIVE)

  // íƒ€ì„ìŠ¤íƒ¬í”„
  joinedAt DateTime  @default(now())
  leftAt   DateTime?

  // ê´€ê³„
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([userId])
  @@index([status])
  @@index([groupId, status])
}

enum GroupMemberRole {
  OWNER
  ADMIN
  MEMBER
}

enum GroupMemberStatus {
  PENDING
  ACTIVE
  LEFT
  KICKED
}

// ============================================
// ê·¸ë£¹ ì´ˆëŒ€ (GroupInvite)
// ============================================
model GroupInvite {
  id        String            @id @default(cuid())
  groupId   String
  invitedBy String
  email     String?
  code      String            @unique @default(cuid())
  status    GroupInviteStatus @default(PENDING)

  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt DateTime  @default(now())
  expiresAt DateTime?
  usedAt    DateTime?
  usedBy    String?

  // ê´€ê³„
  group   Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  inviter User  @relation("GroupInviter", fields: [invitedBy], references: [id])
  user    User? @relation("GroupInvitee", fields: [usedBy], references: [id])

  @@index([groupId])
  @@index([invitedBy])
  @@index([status])
  @@index([code])
}

enum GroupInviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

// ============================================
// ì‹œìŠ¤í…œ ì„¤ì • (System Settings)
// ============================================
model SystemSetting {
  id          String   @id @default(cuid())
  category    String // general, security, notification, feature
  key         String   @unique
  value       String   @db.Text
  type        String // string, number, boolean, json
  description String?
  updatedAt   DateTime @updatedAt
  updatedBy   String

  @@index([category])
  @@index([key])
}
