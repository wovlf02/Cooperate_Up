# 세부 기능 명세

## 개요

1:1 및 그룹 채팅의 각 기능에 대한 상세 명세입니다.

---

## 1. 채팅방 생성

### 1.1 1:1 채팅 시작

**시나리오:**
1. 친구 목록에서 채팅 버튼 클릭
2. 사용자 검색 후 선택
3. 프로필 페이지에서 채팅하기 클릭

**로직:**
```
1. 기존 1:1 채팅방 확인
   - 두 사용자 간 DIRECT 타입 채팅방 검색
   
2. 기존 방 있음
   - 해당 채팅방으로 이동
   - 나갔던 경우 다시 활성화
   
3. 기존 방 없음
   - 새 채팅방 생성
   - 두 사용자를 멤버로 추가
   - 채팅방으로 이동
```

**제한사항:**
- 차단한/된 사용자와 채팅 불가
- 비활성화된 계정과 채팅 불가

---

### 1.2 그룹 채팅 생성

**입력 정보:**
| 필드 | 필수 | 설명 |
|------|------|------|
| 그룹명 | ✅ | 2~30자 |
| 설명 | ❌ | 최대 200자 |
| 그룹 이미지 | ❌ | jpg, png (최대 5MB) |
| 초기 멤버 | ✅ | 최소 1명, 최대 99명 |

**로직:**
```
1. 그룹 정보 입력
2. 멤버 선택 (친구 목록에서)
3. 채팅방 생성
   - 생성자 = OWNER
   - 선택된 멤버 = MEMBER
4. 시스템 메시지 생성: "OOO님이 그룹을 만들었습니다."
5. 초대된 멤버에게 알림
```

**제한사항:**
- 차단 관계인 사용자는 초대 불가
- 그룹당 최대 100명

---

## 2. 메시지 전송

### 2.1 텍스트 메시지

**제한사항:**
- 최대 5,000자
- 빈 메시지 불가
- 연속 전송 제한: 1초에 5개 이내

**포맷팅:**
- URL 자동 링크 변환
- 줄바꿈 유지
- XSS 방지 처리

---

### 2.2 이미지 전송

**지원 형식:**
- jpg, jpeg, png, gif, webp

**처리:**
```
1. 클라이언트
   - 파일 크기 확인 (최대 10MB)
   - 이미지 압축 (옵션)
   - 미리보기 표시

2. 서버
   - 이미지 검증
   - 썸네일 생성 (200x200, 400x400)
   - 원본 및 썸네일 저장
   - 메시지 생성
```

**메시지 데이터:**
```json
{
  "type": "IMAGE",
  "content": "이미지 설명 (선택)",
  "fileUrl": "/uploads/dm/room_id/image.jpg",
  "thumbnailUrl": "/uploads/dm/room_id/thumb_image.jpg",
  "fileName": "photo.jpg",
  "fileSize": 1024000
}
```

---

### 2.3 파일 전송

**지원 형식:**
| 카테고리 | 확장자 | 최대 크기 |
|----------|--------|----------|
| 문서 | pdf, doc, docx, xls, xlsx, ppt, pptx, txt | 50MB |
| 압축 | zip, rar, 7z | 50MB |
| 동영상 | mp4, webm, mov | 100MB |
| 음성 | mp3, wav, m4a | 20MB |

**처리:**
```
1. 파일 업로드
2. 바이러스 검사 (선택)
3. 메타데이터 추출 (파일명, 크기, MIME)
4. 저장 및 메시지 생성
```

**메시지 데이터:**
```json
{
  "type": "FILE",
  "content": "보고서 파일입니다",
  "fileUrl": "/uploads/dm/room_id/report.pdf",
  "fileName": "report.pdf",
  "fileSize": 2048000,
  "fileMimeType": "application/pdf"
}
```

---

### 2.4 답장

특정 메시지를 참조하여 답장

**UI:**
```
┌─────────────────────────────────────┐
│ ┌─────────────────────────────────┐ │
│ │ ↩ 홍길동                         │ │
│ │ 원본 메시지 미리보기...          │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 답장 내용                           │
└─────────────────────────────────────┘
```

**메시지 데이터:**
```json
{
  "content": "답장 내용",
  "replyToId": "original_msg_cuid",
  "replyTo": {
    "id": "original_msg_cuid",
    "content": "원본 메시지 (미리보기용, 최대 100자)",
    "sender": { "id": "...", "name": "홍길동" }
  }
}
```

**제한사항:**
- 삭제된 메시지에 답장 가능 (내용은 "삭제된 메시지"로 표시)
- 다른 채팅방 메시지에 답장 불가

---

## 3. 메시지 수정/삭제

### 3.1 메시지 수정

**조건:**
- 본인 메시지만 수정 가능
- 전송 후 5분 이내만 수정 가능
- 텍스트 메시지만 수정 가능 (파일 메시지 불가)

**표시:**
- 수정된 메시지는 "(수정됨)" 표시
- 수정 시간 기록

---

### 3.2 메시지 삭제

**권한:**
| 삭제 주체 | 조건 |
|-----------|------|
| 본인 | 항상 가능 |
| 방장(OWNER) | 그룹 내 모든 메시지 |
| 관리자(ADMIN) | 그룹 내 일반 멤버 메시지 |

**삭제 방식:**
- Soft Delete (DB에서 `isDeleted = true`)
- UI에서 "삭제된 메시지입니다" 표시
- 답장의 참조는 유지

---

## 4. 읽음 확인

### 4.1 1:1 채팅

**표시:**
```
내 메시지: ✓ (전송됨) / ✓✓ (읽음)
```

**로직:**
```
1. 상대방이 채팅방 진입
2. 마지막 메시지까지 자동 읽음 처리
3. 읽음 이벤트 소켓 전송
4. 발신자 UI 업데이트 (✓ → ✓✓)
```

---

### 4.2 그룹 채팅

**표시:**
```
메시지 아래: "3명 읽음" (클릭 시 목록 표시)
```

**로직:**
- 각 멤버의 `lastReadAt` 기준으로 계산
- 실시간 업데이트 (옵션)

---

## 5. 이모지 반응

메시지에 이모지로 반응

**지원 이모지:**
```
👍 ❤️ 😂 😮 😢 😡 🎉 👏
```

**UI:**
```
메시지 버블 아래:
👍 3  ❤️ 2  (자신이 누른 건 하이라이트)
```

**동작:**
- 같은 이모지 다시 클릭 → 반응 취소
- 다른 이모지 클릭 → 추가 반응 (중복 허용)
- 하나의 이모지당 한 번만 가능

---

## 6. 타이핑 표시

상대방이 입력 중일 때 표시

**로직:**
```
1. 사용자가 입력 시작
   - dm:typing-start 이벤트 발송 (디바운스 500ms)
   
2. 상대방 수신
   - "OOO님이 입력 중..." 표시
   
3. 입력 중단 (2초간 입력 없음)
   - dm:typing-stop 이벤트 발송
   - 표시 제거
```

**그룹 채팅:**
```
1명: "홍길동님이 입력 중..."
2명: "홍길동님, 김철수님이 입력 중..."
3명+: "홍길동님 외 2명이 입력 중..."
```

---

## 7. 알림 설정

### 7.1 채팅방별 알림 음소거

**설정:**
- 전체 음소거 (알림 없음)
- 멘션만 알림 (그룹)
- 기간 설정 (1시간, 8시간, 1일, 영구)

**저장:**
`ChatRoomMember.isMuted = true`

---

### 7.2 푸시 알림

**조건:**
- 알림 ON 상태
- 해당 채팅방에 없을 때 (백그라운드)
- 본인 메시지 제외

**알림 내용:**
```
[1:1] 홍길동: 안녕하세요!
[그룹] 스터디 그룹 (홍길동): 오늘 모임 있나요?
```

---

## 8. 대화 상단 고정

중요한 대화를 상단에 고정

**제한:**
- 최대 5개까지 고정 가능

**정렬 순서:**
```
1. 고정된 채팅방 (고정된 시간순)
2. 일반 채팅방 (최신 메시지순)
```

---

## 9. 메시지 검색

채팅방 내 메시지 검색

**검색 대상:**
- 텍스트 메시지 내용
- 파일명

**필터:**
- 발신자
- 기간 (시작~종료)
- 메시지 유형 (텍스트, 이미지, 파일)

**결과 표시:**
- 검색어 하이라이트
- 해당 메시지로 스크롤 이동

---

## 10. 멤버 관리 (그룹)

### 10.1 멤버 초대

**권한:**
- OWNER: 제한 없음
- ADMIN: 가능
- MEMBER: 설정에 따라 (기본: 불가)

**초대 방법:**
1. 채팅방 설정 > 멤버 초대
2. 친구 목록 / 사용자 검색
3. 선택 후 초대

**처리:**
```
1. 차단 관계 확인
2. 최대 인원 확인
3. 멤버 추가
4. 시스템 메시지: "OOO님이 OOO님을 초대했습니다."
5. 초대된 사용자에게 알림
```

---

### 10.2 멤버 강퇴

**권한:**
- OWNER: 모든 멤버 강퇴 가능
- ADMIN: MEMBER만 강퇴 가능
- MEMBER: 불가

**처리:**
```
1. 강퇴 확인 모달
2. 멤버 isActive = false
3. 시스템 메시지: "OOO님이 OOO님을 내보냈습니다."
4. 강퇴된 사용자 알림
5. 해당 사용자 소켓 연결 해제
```

---

### 10.3 권한 변경

**OWNER만 가능:**
- MEMBER → ADMIN
- ADMIN → MEMBER
- OWNER 이전 (다른 멤버에게)

**OWNER 이전 처리:**
```
1. 새 OWNER 선택
2. 기존 OWNER → ADMIN으로 강등
3. 시스템 메시지: "OOO님이 방장이 되었습니다."
```

---

### 10.4 그룹 나가기

**처리:**
```
1. 나가기 확인
2. 멤버 isActive = false, leftAt = now
3. 시스템 메시지: "OOO님이 나갔습니다."
4. (OWNER인 경우) 자동 OWNER 이전
   - ADMIN이 있으면 가장 오래된 ADMIN
   - 없으면 가장 오래된 MEMBER
   - 마지막 멤버면 채팅방 삭제
```

**나간 후:**
- 채팅방 목록에서 제거
- 대화 기록 접근 불가
- 다시 초대받으면 재입장 가능 (기존 메시지는 안보임)

---

## 11. 그룹 설정

### 11.1 그룹 정보 수정

**수정 가능 항목 (OWNER/ADMIN):**
- 그룹명
- 그룹 설명
- 그룹 이미지

**처리:**
```
1. 정보 수정
2. 시스템 메시지: "OOO님이 그룹 정보를 변경했습니다."
3. 모든 멤버에게 업데이트 브로드캐스트
```

---

### 11.2 그룹 삭제

**OWNER만 가능**

**처리:**
```
1. 삭제 확인 (되돌릴 수 없음 경고)
2. 모든 멤버에게 알림
3. 채팅방 삭제 (Soft Delete)
4. 모든 멤버 목록에서 제거
```

---

## 12. 시스템 메시지

자동 생성되는 메시지

| 이벤트 | 메시지 |
|--------|--------|
| 그룹 생성 | "OOO님이 그룹을 만들었습니다." |
| 멤버 초대 | "OOO님이 OOO님을 초대했습니다." |
| 멤버 입장 | "OOO님이 들어왔습니다." |
| 멤버 퇴장 | "OOO님이 나갔습니다." |
| 멤버 강퇴 | "OOO님이 OOO님을 내보냈습니다." |
| 권한 변경 | "OOO님이 관리자가 되었습니다." |
| 방장 변경 | "OOO님이 방장이 되었습니다." |
| 그룹명 변경 | "그룹명이 'XXX'에서 'YYY'으로 변경되었습니다." |
| 그룹 이미지 변경 | "OOO님이 그룹 이미지를 변경했습니다." |

**표시:**
```
─────────── 12월 15일 ───────────
       홍길동님이 들어왔습니다.
```

